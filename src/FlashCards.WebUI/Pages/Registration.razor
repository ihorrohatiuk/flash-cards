@page "/Registration"
@using System.Text.RegularExpressions
@using FlashCards.Core.Application.Dtos
@using FlashCards.Infrastructure.Services
@inject IAuthenticationService AuthenticationService
@inject NavigationManager NavigationManager

<MudPaper Elevation="4" Style="max-width: 400px;
    margin: 100px auto;
    padding: 30px;
    display: flex;
    flex-direction: column;
    gap: 16px;">
    <MudText Typo="Typo.h4" Align="Align.Center">Registration</MudText>

    <MudForm Valid="_isValid" Spacing="4">
        <MudTextField
            @bind-Value="_registrationRequestDto.Email"
            Label="Email"
            Required="true"
            Validation="@(new Func<string, IEnumerable<string>>(EmailValidation))"
            RequiredError="Email is required" />
        <MudTextField
            @bind-Value="_registrationRequestDto.FirstName"
            Label="First name" Required="true"
            Validation="@(new Func<string, IEnumerable<string>>(FirstNameValidation))"
            RequiredError="First name is required" />
        <MudTextField
            @bind-Value="_registrationRequestDto.LastName"
            Label="Last name" Required="true"
            Validation="@(new Func<string, IEnumerable<string>>(LastNameValidation))"
            RequiredError="Last name is required" />
        <MudTextField
            @bind-Value="_registrationRequestDto.Password"
            Label="Password" Required="true"
            InputType="InputType.Password"
            Validation="@(new Func<string, IEnumerable<string>>(PasswordValidation))"
            RequiredError="Password is required" />

        <MudButton 
            Variant="Variant.Filled" 
            Color="Color.Primary"
            OnClick="SubmitAsync"
            Disabled="@_isRegistrationButtonDisable">Register</MudButton>
    </MudForm>

    @if (_errorMessage != null)
    {
        <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
    }
    @if (_isRegistrationSuccess)
    {
        <MudAlert Severity="Severity.Success">User was successfully created.</MudAlert>
    }
</MudPaper>

@code {
    private string? _errorMessage = null!;
    private bool _isRegistrationSuccess = false;
    private bool _isRegistrationButtonDisable = false;
    private RegistrationRequestDto _registrationRequestDto = new()
    {
        FirstName = null,
        LastName = null,
        Email = null,
        Password = null
    };

    private async Task SubmitAsync()
    {
        try
        {
            _isRegistrationButtonDisable = true;
            _errorMessage = null;
            _isRegistrationSuccess = await AuthenticationService.RegisterAsync(_registrationRequestDto);
            if (_isRegistrationSuccess)
                NavigationManager.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception e)
        {
            _errorMessage = e.Message;
        }
        finally
        {
            _isRegistrationButtonDisable = false;
        }
    }
    //TODO: Move validation to an independent class.
    private IEnumerable<string> EmailValidation(string email)
    {
        if (string.IsNullOrEmpty(email))
        {
            yield return "Email is required.";
            yield break;
        }

        if (!Regex.IsMatch(email, @"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"))
            yield return "Invalid email format.";
        if (email.Length > 50)
            yield return "Email cannot exceed 50 characters.";
    }

    private IEnumerable<string> FirstNameValidation(string firstName)
    {
        if (string.IsNullOrEmpty(firstName))
        {
            yield return "First name is required.";
            yield break;
        }
        
        if (firstName.Length > 50)
            yield return "First name cannot exceed 50 characters.";
    }

    private IEnumerable<string> LastNameValidation(string lastName)
    {
        if (string.IsNullOrEmpty(lastName))
        {
            yield return "Last name is required.";
            yield break;
        }
        
        if (lastName.Length > 50)
            yield return "Last name cannot exceed 50 characters.";
    }
    
    private IEnumerable<string> PasswordValidation(string password)
    {
        if (string.IsNullOrEmpty(password))
        {
            yield return "Password is required";
            yield break;
        }
        
        if (password.Length is < 8 or > 100)
            yield return "Password must be at least 8 characters and no more than 100 characters.";
    }
}